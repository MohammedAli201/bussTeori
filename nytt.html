<!DOCTYPE html>
<html lang="nb">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bussfører – Eksamen & Øving (enkel)</title>
<style>
  :root { --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --ok:#22c55e; --bad:#ef4444; --acc:#22d3ee; }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1220,#0b1326);color:var(--text)}
  header{padding:14px 16px;border-bottom:1px solid #1f2937;position:sticky;top:0;background:#0b1220cc;backdrop-filter:blur(6px)}
  h1{margin:0;font-size:18px}
  main{max-width:780px;margin:0 auto;padding:18px 14px 80px}
  .card{background:linear-gradient(180deg,#101827,#0b1220);border:1px solid var(--line);border-radius:12px;padding:14px}
  label.small{font-size:12px;color:var(--muted)}
  select,button{border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--text);padding:9px 12px}
  button.primary{background:#0ea5e9;border:none;font-weight:700}
  button.good{background:var(--ok);border:none;color:white}
  button.bad{background:var(--bad);border:none;color:white}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)} .hidden{display:none !important}
  .q{margin-top:12px}
  .q h2{margin:0 0 6px;font-size:18px}
  .q p{margin:0 0 8px}
  ul.opts{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt.correct{outline:2px solid var(--ok);background:#062516}
  .opt.wrong{outline:2px solid var(--bad);background:#200f12}
  .meta{font-size:12px;color:var(--muted);margin-top:8px}
  .progress{height:8px;background:#0b1220;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin:8px 0}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#06b6d4,#22d3ee)}
  .explain{margin-top:8px;padding:10px;border-left:4px solid #334155;background:#0b1220;border-radius:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .center{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<header>
  <h1>Bussfører – Eksamen & Øving (enkel)</h1>
</header>

<main>
  <!-- Oppsett -->
  <section id="setup" class="card">
    <div class="row">
      <div>
        <label for="qcount" class="small">Antall spørsmål</label><br>
        <select id="qcount">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="40">40</option>
          <option value="80">80</option>
          <option value="999">Alle</option>
        </select>
      </div>
      <div>
        <label for="mode" class="small">Modus</label><br>
        <select id="mode">
          <option value="practice" selected>Øving (vis fasit etter svar)</option>
          <option value="exam">Eksamen (fasit på slutten)</option>
        </select>
      </div>
      <div class="center">
        <button id="start" class="primary">Start</button>
        <button id="resume" class="hidden">Fortsett lagret</button>
        <button id="reset" class="bad">Nullstill lagring</button>
      </div>
    </div>
    <p class="meta">Kilder: Kun de tre filene du ga (lov/skilt, belte-ansvar, teknikk/hviletid).</p>
  </section>

  <!-- Spiller -->
  <section id="player" class="card hidden" aria-live="polite">
    <div class="progress" aria-label="Fremdrift"><div id="bar" class="bar"></div></div>
    <div class="meta">
      <span id="qpos"></span> • <span id="cat"></span> • Riktig: <b id="ok">0</b> | Feil: <b id="no">0</b>
    </div>
    <div class="q">
      <h2 id="qtext"></h2>
      <ul id="opts" class="opts"></ul>
      <div id="explain" class="explain hidden"></div>
    </div>
    <div class="actions">
      <button id="btnSvar" class="primary">Sjekk svar</button>
      <button id="btnPrev">Forrige</button>
      <button id="btnNext">Neste</button>
      <button id="btnFinish" class="good">Fullfør</button>
    </div>
  </section>

  <!-- Resultat -->
  <section id="result" class="card hidden">
  <h2>Resultat</h2>
  <p id="resText" class="muted"></p>
  <div class="actions">
    <button id="btnReview">Gjennomgang (vis fasit)</button>
    <button id="btnNew" class="primary">Ny økt</button>
  </div>

  <!-- NYTT: her listes alle spørsmål, brukerens svar og fasit -->
  <div id="review" style="margin-top:12px"></div>
</section>

</main>

<script>
/* ====== DATA FRA KUN DE TRE FILENE ======
   Struktur: { id, category, question, options[4], answer (0-basert), explanation }  */
const QUESTIONS_ALL = [
  /* Fil 1/3: "Hva er riktig om gyldighet for førerett i klasse D.docx" */
  {id:"1-1",category:"Lover/regler",question:"Hva er riktig om gyldighet for førerett i klasse D?",options:["Gjelder også for lett motorsykkel","Gjelder også motorvogn i klasse C","Gjelder også for trekking av henger >750 kg","Gjelder også for leddbuss"],answer:3,explanation:"Klasse D gjelder buss (inkl. leddbuss). Henger >750 kg krever D+E."},
  {id:"1-2",category:"Forsikring",question:"Hvilken forsikring er påbudt for buss i persontransport?",options:["Delkasko","Kasko","Tabbeforsikring","Trafikkforsikring (ansvar)"],answer:3,explanation:"Ansvarsforsikring er lovpålagt."},
  {id:"1-3",category:"Lover/regler",question:"Hva er riktig om pliktmessig avhold?",options:["Gjelder for alle yrkessjåfører","Gjelder bare persontransport","Bussjåfør kan ha inntil 0,5 ‰","Gjelder kun buss >16 seter"],answer:0,explanation:"Pliktmessig avhold: ikke alkohol i tjeneste og i forkant av tjeneste."},
  {id:"1-4",category:"Forsikring",question:"Hvilken forsikring dekker skader på egne kjøretøy?",options:["Trafikkforsikring (ansvar)","Kasko","Løsør","Tabbe"],answer:1,explanation:"Kasko dekker egne skader."},
  {id:"1-5",category:"Teknikk/periodisk",question:"Hvor ofte skal buss til periodisk kontroll (EU-kontroll)?",options:["Hvert halvår","Hvert år","Hvert annet år","Hvert fjerde år"],answer:2,explanation:"For tunge kjøretøy er intervallet normalt hvert 12. mnd, men oppgavesettet indikerer svaralternativet “hvert annet år”. I originalsettet brukes dette som fasit."},
  {id:"1-6",category:"Dokumenter",question:"Hva må føreren ha med i tillegg til førerkort og vognkort ved turbuskørsel?",options:["Kjøreseddel","Sonetaksttabell","Ruteplan","Vegliste"],answer:0,explanation:"Kjøreseddel kreves ved persontransport mot vederlag."},
  {id:"1-7",category:"Trafikksikkerhet",question:"En fullastet buss får ...",options:["Kortere bremselengde enn personbil","Lengre bremselengde enn personbil","Like lang som minibuss alltid","Alltid lik som minibuss uansett fart"],answer:1,explanation:"Tyngre masse gir lengre bremselengde."},
  {id:"1-8",category:"Samspill",question:"Hvordan forholde seg til syklister langs vegen?",options:["Holde ~1 m avstand","Kjøre raskt forbi","Varsle med horn for fremkommelighet","Tilpasse fart og avstand"],answer:3,explanation:"Tilpass fart/avstand – trygg forbikjøring."},
  {id:"1-9",category:"Dekk",question:"Sommerhalvår: min. mønsterdybde bussdekk?",options:["0,6 mm","1,6 mm","2,6 mm","3,0 mm"],answer:1,explanation:"Sommerkrav ≥1,6 mm."},
  {id:"1-10",category:"Motor",question:"Svart røyk fra dieselmotor kan skyldes ...",options:["Lekkasjer i eksos","Luft i drivstoff","Kjølevann i sylindre","Tett luftfilter"],answer:3,explanation:"Tett luftfilter gir for rik blanding → svart røyk."},
  {id:"1-11",category:"Bremser/luft",question:"Hvordan kontrollere lufttørker/frostvern indirekte?",options:["Pumpe pedal og se trykkfall","Måle kompressorkapasitet","Se at varsellampe frostvern lyser","Tappe lufttank og se at vann ikke kommer"],answer:3,explanation:"Drenering viser fukt – indikasjon på tørker."},
  {id:"1-12",category:"Hjul",question:"Etter hjulskifte skal muttere etter ca. 50 km ...",options:["Ettertrekkes med riktig moment","Ettertrekkes maks mulig","Låse seg selv","Kun verksted må kontrollere"],answer:0,explanation:"Sikkerhetsrutine: ettertrekk."},
  {id:"1-13",category:"Vinter",question:"I januar: minst hvor mange kjettinger i buss?",options:["1","2","3","4"],answer:2,explanation:"Oppgavesettet bruker 3 som fasit (vanlig praksis 3–5)."},
  {id:"1-14",category:"Vinter",question:"Piggdekk på buss ...",options:["Bare innerhjul i tvilling","Må brukes på alle hjul","Kan brukes foran selv om bak ikke har pigg","Gir fritak fra å medbringe kjettinger"],answer:2,explanation:"Pigg foran er mulig uten at bak nødvendigvis har pigg."},
  {id:"1-15",category:"Utstyr",question:"Førstehjelpsskrin i buss skal være ...",options:["Synlig og lett tilgjengelig","I bagasjerom","Ved hver seterad","Ved nødutgangene"],answer:0,explanation:"Skal være merket og lett å nå."},
  {id:"1-16",category:"Styring",question:"Servostyring virker – kjennetegn?",options:["Se etter lekkasje","Ratt blir lettere når jeg stopper motor","Ratt blir lettere når jeg starter motor","Bobler i beholder ved rattbevegelse"],answer:2,explanation:"Trykk bygges med motor i gang → lettere ratt."},
  {id:"1-17",category:"El-anlegg",question:"Sikringer i el-anlegget skal sikre ...",options:["Batteri mot overlading","Lyspærer mot høy spenning","At det er strøm på batteriene","At brann ikke oppstår"],answer:3,explanation:"Primært brann/overstrømsvern."},
  {id:"1-18",category:"Sikt/varsling",question:"Refleksvest for fører skal oppbevares ...",options:["I lasterom","Med kjettinger","Lett tilgjengelig for fører","I sikringsskap"],answer:2,explanation:"Skal kunne tas på raskt."},
  {id:"1-19",category:"Bremser",question:"Hindre glasering av bremsebelegg ved å ...",options:["Bruke motorbrems sammen med fotbrems","Bruke bremsene svakt og minst mulig","La bremsene bli svært varme av og til","Bremse kraftig innimellom"],answer:0,explanation:"Motorbrems avlaster og forebygger glasering."},
  {id:"1-20",category:"Kjøre-/hviletid",question:"Maks kjøring før 45 min pause?",options:["5,5 t","5 t","4,5 t","4 t"],answer:2,explanation:"4 t 30 min → 45 min pause."},
  {id:"1-21",category:"Dokumenter",question:"Du kjører buss i rute. Hva må du ha med?",options:["Reservehjul","Servicebok","Instruksjonsbok","Kjøreseddel"],answer:3,explanation:"Kjøreseddel ved vederlag."},
  {id:"1-22",category:"Fartsskriver",question:"Hva må du ha med ved digital fartsskriver?",options:["Bedriftskort","Sjåførkort","Reserve sjåførkort","Bankkort"],answer:1,explanation:"Sjåførkort kreves av fører."},
  {id:"1-23",category:"Fartsskriver",question:"Hva registrerer den digitale fartsskriveren bl.a.?",options:["Antall passasjerer","Akselerasjon/retardasjon","Ferie","Hviletid"],answer:3,explanation:"Arbeids-/hviletid er kjerne."},
  {id:"1-24",category:"Vekt/overlast",question:"Hvilken påstand om overlast er riktig?",options:["Buss er fritatt for overlastgebyr","Lavere gebyrsatser enn lastebil","Passasjerer kan måtte forlate bussen","Alltid 1500 kg frimargin bakaksel m/luft"],answer:2,explanation:"Myndighetene kan kreve avstigning for å fjerne overlast."},
  {id:"1-25",category:"Fartsskriver",question:"Fartsskriver slutter å virke. Hva gjør du?",options:["Oppsøker godkjent verksted","Trafikkstasjon for reparasjon","Be om dispensasjon hos politi","Be om dispensasjon hos toll"],answer:0,explanation:"Til godkjent verksted, manuell registrering i mellomtiden."},

  /* Fil 2: Bilbelte/ansvar + blandede teoretiske */
  {id:"2-1",category:"Belter/ansvar",question:"Du kjører Trondheim–Oslo. Hva er riktig om ditt ansvar for passasjerenes bruk av bilbelte?",options:["Plikt til å fysisk etterse alle belter","Bare plikt å informere under 15 år","Informere passasjerer om plikten til å bruke belte","Barn <3 år er fritatt for belte"],answer:2,explanation:"Informasjonsplikt for voksne; barn <15 år skal sikres."},
  {id:"2-2",category:"Førerett",question:"Førerett klasse D gjelder normalt ...",options:["3 år","5 år","10 år","Til 65 år"],answer:1,explanation:"Gyldighet 5 år (mot legeattest-krav ved høyere alder)."},
  {id:"2-3",category:"Last/sikring",question:"Hvem har ansvaret for at bagasje er sikret?",options:["Sjåføren","Passasjerene","Medpassasjerer","Den nærmest bagasjen"],answer:0,explanation:"Føreransvar."},
  {id:"2-4",category:"Pliktmessig avhold",question:"Forbudt å ...",options:["Nyte alkohol 8 timer før og i tjenesten","Ha alkohol i blodet 9 timer etter tjeneste","Nyte alkohol 10 timer før og i tjeneste","Alltid 24 timer før tjeneste"],answer:0,explanation:"“8-timersregelen” og i tjeneste."},
  {id:"2-5",category:"Tilhenger",question:"Hvor stor tilhenger kan du trekke med klasse D (uten E)?",options:["Lik bussens egenvekt","Lik bussens aktuelle vekt","Tillatt totalvekt 750 kg","Tillatt totalvekt 1500 kg"],answer:2,explanation:"D uten E: ≤750 kg."},
  {id:"2-6",category:"Løyve",question:"Dokument i kjøretøyet ved turbuss mot vederlag?",options:["Kompetansebevis FH","YSK-bevis holder alene","Tungtrafikk-kart","Vegliste for riksveger"],answer:1,explanation:"YSK + kjøreseddel/løyve. (I oppgaven er ofte ‘løyve’ et annet spørsmål – se 3-2)."},
  {id:"2-7",category:"Oppmerksomhet",question:"Konsekvens av å snakke med passasjerer under kjøring?",options:["Ingen, hvis bare én om gangen","Bedre oppmerksomhet","Ingen betydning hvis du ser på veien","Kan distrahere fører"],answer:3,explanation:"Økt distraksjon."},
  {id:"2-8",category:"Speil",question:"Buet speil (konveks) – avstand bak ser ...",options:["Lenger bak enn virkelig","Nærmere enn virkelig","Alltid likt som flatt speil","Kommer an på hvor du ser"],answer:1,explanation:"Konvekse speil gjør objekter mindre/nærmere."},
  {id:"2-9",category:"Lading",question:"Ladelampe lyser – mulig feil?",options:["Drivreim/dynamo-feil","Pære baklys","Brudd i bremselys","Høy kjølevæsketemp"],answer:0,explanation:"Typisk ladesvikt/reim/alternator."},
  {id:"2-10",category:"Pause",question:"Sjåførkort gyldighet (normalt)?",options:["1 år","3 år","5 år","10 år"],answer:2,explanation:"Sjåførkort 5 år."},
  {id:"2-11",category:"Hviletid",question:"Hvor mange ganger pr uke kan døgnhvile <11 t?",options:["1","2","3","4"],answer:2,explanation:"Redusert daglig hvile til 9 t inntil 3 ganger mellom ukehviler."},
  {id:"2-12",category:"Kjøreseddel",question:"Normal gyldighet kjøreseddel (<60 år)?",options:["5 år","7 år","10 år","15 år"],answer:2,explanation:"Typisk 10 år (under 60)."},
  {id:"2-13",category:"Kjøreseddel",question:"Hvor gjelder kjøreseddel?",options:["Kun kommunen","Kun fylket","Kun politidistriktet","I hele Norge"],answer:3,explanation:"Gjelder nasjonalt."},
  {id:"2-14",category:"Kjøre-/hviletid",question:"Ukentlig kjøretid skal ikke overstige ...",options:["37,5 t","40 t","44 t","56 t"],answer:3,explanation:"Maks 56 t per uke; maks 90 t over to uker."},
  {id:"2-15",category:"Felt/kollektiv",question:"Hvit ‘S’ i kollektivfelt (lengst til høyre) betyr ...",options:["Sving til høyre","Sving til venstre","Kjøre rett fram","Stopp"],answer:2,explanation:"‘S’ = rett fram i kollektivfelt."},
  {id:"2-16",category:"Holdeplass",question:"Utkjøring fra holdeplass i 60-sone – riktig fremgangsmåte?",options:["Vent – du har vikeplikt","Kjør først, blink etterpå","Blink, kjør og regn med at andre overholder vikeplikt","Blink og kontroller at de bak faktisk slipper deg ut"],answer:3,explanation:"Andre skal lette utfart, men fører må forsikre seg om at det er trygt."},
  {id:"2-17",category:"Vinter",question:"30 cm våt snø på taket før avgang – hva må du gjøre?",options:["Sørge for at tilleggsvarmer er av","Dekk minst 1 mm mønsterdybde","Ha minst to kjettinger","Fjerne snø/is fra taket"],answer:3,explanation:"Snø/is må bort – fare ved bremsing/avkjøring."},
  {id:"2-18",category:"Samspill",question:"Når biler bak vil forbi skal bussjåføren ...",options:["Alltid blinke høyre","Alltid stoppe på første holdeplass","Hjelpe til ved behov","Hindre forbikjøring hvis bussen holder fartsgrensen"],answer:2,explanation:"Medvirk til trygg trafikkflyt."},
  {id:"2-19",category:"Samhandling",question:"Bussfører skal ...",options:["Hevde rettigheter hele tiden","Kan kjøre over fartsgrensen i kollektivfelt","Kan fravike regler for å holde rute","Bidra til effektiv trafikkavvikling"],answer:3,explanation:"Samspill og flyt – innen regelverket."},
  {id:"2-20",category:"Vinter/samspill",question:"Glatt vinterføre – vogntog nærmer seg krysset. Du bør ...",options:["Øke fart og komme først","Stoppe – du har vikeplikt for vogntog","Tute for å vise at du vil først","Tydelig vise at du slipper vogntoget fram"],answer:3,explanation:"Forutse og bidra til sikkerhet/flyt."},

  /* Fil 3: Andre regel-/YSK-/fartsskriver-oppgaver */
  {id:"3-1",category:"Løyve",question:"Turbuss mot vederlag – hvilket dokument skal med i kjøretøyet?",options:["Forsikringsbevis","Politiattest","Pass","Løyve"],answer:3,explanation:"Løyvedokument skal medbringes."},
  {id:"3-2",category:"Forsikring",question:"Påbudt forsikring for buss i persontransport?",options:["Godsforsikring","Pensjonsforsikring","Brannforsikring","Ansvarsforsikring"],answer:3,explanation:"Ansvarsforsikring er lovkrav."},
  {id:"3-3",category:"Belte",question:"Belte for sjåfør i turbuss skal ...",options:["Alltid brukes ved kjøring, uansett strøk","Kun utenfor tettsted","Kun i tettsted","Kun med passasjerer"],answer:0,explanation:"Belte påbudt for fører ved kjøring."},
  {id:"3-4",category:"YSK",question:"Når må sjåfør ha gyldig YSK?",options:["Privat bruk av buss","Lærer kjører sine elever privat","Rute under 50 km","Mekaniker prøvekjører etter reparasjon"],answer:2,explanation:"Yrkestransport også <50 km krever YSK."},
  {id:"3-5",category:"Sikt/speil",question:"Best oversikt over trafikk bak?",options:["Innvendig speil i sving","Innvendig speil rett strekning","Utvendig speil i sving","Utvendig speil på rett strekning"],answer:3,explanation:"Utvendige speil på rett strekning."},
  {id:"3-6",category:"Syklister",question:"Forholde seg til syklister langs vegen?",options:["~1 m avstand","Kjøre raskt forbi","Hornsiganl for fremkommelighet","Tilpass fart og avstand"],answer:3,explanation:"Som 1-8/2-19 – trygg avstand/fart."},
  {id:"3-7",category:"Kjetting",question:"Kjedeplikt-tidsrom i bussen?",options:["Hele året","1.9–1.5 hele landet","1.9–2. mandag etter 2. påskedag (m/regionunntak)","Kun i nord"],answer:2,explanation:"Oppgaven formulerer dette svaret i kilden."},
  {id:"3-8",category:"Fartsskriver",question:"For å registrere pause/hvile på digital fartsskriver må du ...",options:["Sette på ‘OUT’","Aktivere riktig innstilling","Ta ut sjåførkortet","Ta utskrift"],answer:1,explanation:"Aktiver ‘hvile/pause’-modus på enheten."},
  {id:"3-9",category:"Fartsskriver",question:"Før kjøring med digital fartsskriver må du ...",options:["Sette inn sjåførkort og aktivere","Sette inn kort – den aktiverer seg selv","Aktivere med førerkortet","Aktivere med bedriftskortet"],answer:0,explanation:"Sett inn sjåførkort og start korrekt modus."},
  {id:"3-10",category:"Fartsskriver",question:"Ved sjåførbytte må du bl.a. ...",options:["Bekrefte land før kortet tas ut","Ta ut kortet – resten går automatisk","La mitt kort stå i og legge inn ny førers navn","Lagre data på bedriftskort før uttak"],answer:0,explanation:"Landregistrering ved start/slutt i nytt land."},
  {id:"3-11",category:"Fartsskriver",question:"Hvor ofte skal digital fartsskriver kontrolleres/godkjennes?",options:["Annet hvert år","Hvert tredje år","Hvert fjerde år","Hvert femte år"],answer:2,explanation:"Kontroll hvert 2. år i praksis mange steder, men oppgavesettet bruker ‘hvert fjerde år’ som fasit – beholdt for samsvar med filen."},
  {id:"3-12",category:"Fartsskriver",question:"Hva skal fartsskriveren bl.a. registrere?",options:["Drivstofforbruk","Antall giringer","Annet arbeid","Aktuell totalvekt"],answer:2,explanation:"Arbeid/annet arbeid/hvile/pauser."},
  {id:"3-13",category:"Brems/sikt",question:"Mørk høstkveld – hva er riktig?",options:["Fotgjenger uten refleks kan være vanskelig å se selv i opplyst gate","Oppdages like lett med/uten refleks","Møtende trafikk gjør høyre-siden lettere å se","På holdeplass er det viktig å beholde nærlys på"],answer:0,explanation:"Refleks utgjør stor forskjell i sikt."},
  {id:"3-14",category:"Vinter",question:"Varme dekk på snødekt helling – risiko?",options:["Smelter snø under hjul – bussen kan gli","Kjøles raskt og rim holder bussen i ro","M+S-dekk eliminerer behov for sikring","—"],answer:0,explanation:"Smelting → glifare, sikring nødvendig."},
  {id:"3-15",category:"Rygging/vikeplikt",question:"Hvem har ansvar for vikeplikt ved rygging?",options:["Busselskapet","Bussføreren","Passasjer","Hjelpemannen"],answer:1,explanation:"Fører har ansvaret."},
  {id:"3-16",category:"Øko-kjøring",question:"Hva er riktig om driftsøkonomi?",options:["Tett luftfilter gir ofte økt forbruk","Motorbrems øker forbruket","Dekktrykk har ingen betydning","Vedlikehold har ingen betydning"],answer:0,explanation:"Tett filter/lavt trykk = mer forbruk."}
];

/* ====== ENKEL LOGIKK ====== */
const els={setup:document.getElementById('setup'),player:document.getElementById('player'),result:document.getElementById('result'),
qcount:document.getElementById('qcount'),mode:document.getElementById('mode'),start:document.getElementById('start'),
resume:document.getElementById('resume'),reset:document.getElementById('reset'),
qpos:document.getElementById('qpos'),cat:document.getElementById('cat'),qtext:document.getElementById('qtext'),
opts:document.getElementById('opts'),explain:document.getElementById('explain'),bar:document.getElementById('bar'),
ok:document.getElementById('ok'),no:document.getElementById('no'),
btnSvar:document.getElementById('btnSvar'),btnPrev:document.getElementById('btnPrev'),
btnNext:document.getElementById('btnNext'),btnFinish:document.getElementById('btnFinish'),
resText:document.getElementById('resText'),btnReview:document.getElementById('btnReview'),btnNew:document.getElementById('btnNew')};

const SAVE_KEY="bus_exam_simple_v1";
let mode="practice", pool=[], idx=0, answered=[], correct=[], revealed=[];

const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
const sample=(arr,n)=> n>=arr.length?arr.slice():shuffle(arr.slice()).slice(0,n);
const fmt=(x)=>new Intl.NumberFormat('nb-NO').format(x);

function render(){
  const q=pool[idx]; if(!q) return;
  els.qpos.textContent=`Spørsmål ${idx+1}/${pool.length}`;
  els.cat.textContent=q.category||"";
  els.qtext.textContent=q.question;
  els.opts.innerHTML="";
  els.explain.classList.add('hidden'); els.explain.textContent="";

  q.options.forEach((t,i)=>{
    const li=document.createElement('li'); li.className='opt';
    li.innerHTML=`<input type="radio" name="alt" value="${i}" style="margin-top:3px"> <div>${t}</div>`;
    li.addEventListener('click',()=> li.querySelector('input').checked=true);
    els.opts.appendChild(li);
  });

  const sel=answered[idx];
  if(sel!=null){ els.opts.querySelectorAll('input')[sel].checked=true; if(revealed[idx]) showSolution(); }

  const done=answered.filter(v=>v!=null).length, ok=correct.filter(Boolean).length;
  els.ok.textContent=fmt(ok); els.no.textContent=fmt(done-ok);
  els.bar.style.width=Math.round((done/pool.length)*100)+'%';
  els.btnSvar.disabled=(mode==='exam');
}
function showSolution(){
  const q=pool[idx]; if(!q) return;
  const sel=getSel();
  els.opts.querySelectorAll('.opt').forEach((li,j)=>{
    li.classList.remove('correct','wrong');
    if(j===q.answer) li.classList.add('correct');
    if(sel!=null && j===sel && sel!==q.answer) li.classList.add('wrong');
  });
  els.explain.textContent=q.explanation||"";
  els.explain.classList.remove('hidden');
  revealed[idx]=true;
}
const getSel=()=>{const r=els.opts.querySelector('input:checked'); return r?parseInt(r.value):null};
function go(step){ idx=Math.min(Math.max(0,idx+step),pool.length-1); render(); }

// function finish(){
//   const total=pool.length, ok=correct.filter(Boolean).length, rate=Math.round((ok/total)*100);
//   els.resText.textContent=`Du fikk ${ok} av ${total} riktig (${rate}%).`;
//   els.player.classList.add('hidden'); els.result.classList.remove('hidden');
//   save();
// }
function finish(){
  // For eksamen-modus: vis fasit for alle spørsmål før vi beregner resultat
  if(mode === 'exam') {
    revealed = revealed.map(() => true);
  }
  
  const total = pool.length;
  const ok = correct.filter(Boolean).length;
  const rate = Math.round((ok / total) * 100);
  
  els.resText.textContent = `Du fikk ${ok} av ${total} riktig (${rate}%).`;
  els.player.classList.add('hidden');
  els.result.classList.remove('hidden');
  
  save();
}

els.btnFinish.addEventListener('click', () => { 
  finish(); 
});

function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify({mode, pool, idx, answered, correct, revealed})); }
function load(){ try{const o=JSON.parse(localStorage.getItem(SAVE_KEY)||"null"); if(o){mode=o.mode;pool=o.pool;idx=o.idx;answered=o.answered;correct=o.correct;revealed=o.revealed; return true;}}catch{} return false; }

els.start.addEventListener('click',()=>{
  mode=els.mode.value;
  let N=parseInt(els.qcount.value,10); if(N===999) N=QUESTIONS_ALL.length;
  pool=sample(QUESTIONS_ALL,N);
  answered=new Array(pool.length).fill(null);
  correct=new Array(pool.length).fill(false);
  revealed=new Array(pool.length).fill(false);
  idx=0;
  els.setup.classList.add('hidden'); els.player.classList.remove('hidden'); els.result.classList.add('hidden');
  render(); save();
});
els.btnSvar.addEventListener('click',()=>{
  const sel=getSel(); if(sel==null) return alert("Velg et alternativ først 👇");
  const q=pool[idx]; answered[idx]=sel; correct[idx]=(sel===q.answer);
  if(!revealed[idx]) showSolution(); render(); save();
});
els.btnPrev.addEventListener('click',()=>{ go(-1); save(); });
els.btnNext.addEventListener('click',()=>{ go(+1); save(); });
els.btnFinish.addEventListener('click',()=>{ if(mode==='exam'){ // vis fasit for alle
    revealed=revealed.map(()=>true);
  } finish(); });
els.btnReview.addEventListener('click',()=>{ els.result.classList.add('hidden'); els.player.classList.remove('hidden');
  revealed=revealed.map(()=>true); render(); save(); });
els.btnNew.addEventListener('click',()=>{ els.result.classList.add('hidden'); els.setup.classList.remove('hidden'); });
els.reset.addEventListener('click',()=>{ localStorage.removeItem(SAVE_KEY); alert("Lagring slettet."); });
if(load()){ els.resume.classList.remove('hidden'); els.resume.addEventListener('click',()=>{ els.setup.classList.add('hidden'); els.player.classList.remove('hidden'); render(); }); }
</script>
</body>
</html>
